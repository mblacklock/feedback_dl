<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Feedback Generator</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 2rem;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: #0f172a;
        }

        .criteria-list {
            background: var(--surface);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Revised Layout */
        .row {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: block;
            /* Nested layout */
        }

        .row:last-child {
            border-bottom: none;
        }

        .row-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .row-label {
            font-weight: 600;
            color: #475569;
            font-size: 1.125rem;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #94a3b8;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            color: var(--primary);
            background-color: #f1f5f9;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr 100px;
            gap: 1rem;
            align-items: start;
        }

        .option-block {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .radio-label:hover {
            background-color: #f1f5f9;
        }

        .radio-label input[type="radio"] {
            accent-color: var(--primary);
            width: 1.125rem;
            height: 1.125rem;
        }

        .feedback-text {
            font-size: 0.875rem;
            color: #64748b;
            background: #f8fafc;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            line-height: 1.4;
            min-height: 2.5rem;
        }

        .sticky-sidebar {
            position: sticky;
            top: 2rem;
        }

        .result-box {
            background: var(--surface);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        textarea {
            width: 100%;
            height: 400px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 1rem;
            font-size: 1rem;
            box-sizing: border-box;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: white;
            font-weight: 500;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background-color: #cbd5e1;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #10b981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.show {
            transform: translateY(0);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            background: white;
            z-index: 10;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #475569;
        }
    </style>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('feedbackApp', () => ({
                selections: {},
                finalFeedback: '',
                showNotification: false,
                rowIds: [],

                // Edit State
                showModal: false,
                editingRow: {
                    id: null,
                    label: '',
                    positive: '',
                    negative: ''
                },

                init() {
                    console.log('Feedback app initializing...');
                    try {
                        const rowIdsText = document.getElementById('row-ids-data').textContent;
                        this.rowIds = JSON.parse(rowIdsText);
                        console.log('Loaded row IDs:', this.rowIds);
                    } catch (e) {
                        console.error('Error parsing row IDs:', e);
                    }
                },

                openEditModal(id, label, positive, negative) {
                    this.editingRow = { id, label, positive, negative };
                    this.showModal = true;
                },

                openAddModal() {
                    this.editingRow = { id: null, label: '', positive: '', negative: '' };
                    this.showModal = true;
                },

                saveRow() {
                    const isNew = this.editingRow.id === null;
                    const url = isNew ? '/add_row/' : '/edit_row/';

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: this.editingRow.id,
                            label: this.editingRow.label,
                            text_positive: this.editingRow.positive,
                            text_negative: this.editingRow.negative
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.reload();
                            } else {
                                alert('Error saving: ' + data.message);
                            }
                        })
                        .catch(err => alert('Network error: ' + err));
                },

                deleteRow() {
                    if (!confirm('Are you sure you want to delete this criterion? This cannot be undone.')) return;

                    fetch('/delete_row/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: this.editingRow.id
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.reload();
                            } else {
                                alert('Error deleting: ' + data.message);
                            }
                        })
                        .catch(err => alert('Network error: ' + err));
                },

                updateFeedback(id, text) {
                    this.selections[id] = text;
                    this.generateText();
                },

                generateText() {
                    this.finalFeedback = this.rowIds
                        .map(id => this.selections[id])
                        .filter(text => text && text.trim() !== '')
                        .join(' ');
                },

                copyToClipboard() {
                    navigator.clipboard.writeText(this.finalFeedback).then(() => {
                        this.showNotification = true;
                        setTimeout(() => this.showNotification = false, 2000);
                    });
                },

                resetForm() {

                    this.selections = {};
                    this.finalFeedback = '';

                    // Reset all radio buttons to 'None'
                    document.querySelectorAll('input[type="radio"][value="none"]').forEach(el => {
                        el.checked = true;
                    });
                }
            }))
        })
    </script>
</head>

<body x-data="feedbackApp">

    <script id="row-ids-data" type="application/json">{{ row_ids|safe }}</script>

    <!-- Modal -->
    <div class="modal-overlay" x-show="showModal" x-transition.opacity style="display: none;">
        <div class="modal-content" x-transition.scale>
            <h2 x-text="editingRow.id ? 'Edit Feedback' : 'Add New Criteria'"></h2>
            <div class="form-group">
                <label>Label (Title)</label>
                <input type="text" x-model="editingRow.label" class="form-input" placeholder="e.g. Introduction">
            </div>
            <div class="form-group">
                <label>Positive Feedback</label>
                <textarea x-model="editingRow.positive" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>Negative Feedback</label>
                <textarea x-model="editingRow.negative" rows="4"></textarea>
            </div>
            <div class="modal-actions">
                <button x-show="editingRow.id" class="btn btn-danger" @click="deleteRow"
                    style="margin-right: auto;">Delete</button>
                <button class="btn btn-secondary" @click="showModal = false">Cancel</button>
                <button class="btn" @click="saveRow">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div>
            <h1>Assessment Feedback</h1>
            <div class="criteria-list">
                {% for row in rows %}
                <div class="row" id="row-{{ row.id }}">
                    <div class="row-header">
                        <div class="row-label">{{ row.label|default:"Criteria" }}</div>
                        <button class="icon-btn"
                            @click="openEditModal({{ row.id }}, `{{ row.label|escapejs }}`, `{{ row.text_positive|escapejs }}`, `{{ row.text_negative|escapejs }}`)"
                            title="Edit Feedback Text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="options">
                        <div class="option-block">
                            <label class="radio-label">
                                <input type="radio" name="row_{{ row.id }}" value="positive"
                                    @change="updateFeedback({{ row.id }}, '{{ row.text_positive|escapejs }}')">
                                <strong>Positive</strong>
                            </label>
                            <div class="feedback-text">{{ row.text_positive }}</div>
                        </div>

                        <div class="option-block">
                            <label class="radio-label">
                                <input type="radio" name="row_{{ row.id }}" value="negative"
                                    @change="updateFeedback({{ row.id }}, '{{ row.text_negative|escapejs }}')">
                                <strong>Negative</strong>
                            </label>
                            <div class="feedback-text">{{ row.text_negative }}</div>
                        </div>

                        <div class="option-block">
                            <label class="radio-label">
                                <input type="radio" name="row_{{ row.id }}" value="none" checked
                                    @change="updateFeedback({{ row.id }}, '')">
                                <strong>None</strong>
                            </label>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button class="btn btn-secondary" style="margin-top: 1rem; width: 100%;" @click="openAddModal()">
                + Add New Criteria
            </button>
        </div>

        <div class="sticky-sidebar">
            <div class="result-box">
                <h3 style="margin-top: 0; margin-bottom: 1rem;">Generated Feedback</h3>
                <textarea x-model="finalFeedback" placeholder="Select criteria to generate feedback..."></textarea>
                <button class="btn" @click="copyToClipboard">
                    Copy to Clipboard
                </button>
                <button class="btn btn-secondary" style="margin-top: 0.5rem;" @click="resetForm">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <div class="notification" :class="{ 'show': showNotification }">
        Copied to clipboard!
    </div>
</body>

</html>